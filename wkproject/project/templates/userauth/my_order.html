{% extends "partials/base.html" %}
{% block content %}
<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Order detail</h2>
            <p>Details for Order ID: {{order.order_number}}</p>
        </div>
    </div>

    <div class="card">
        <header class="card-header">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                    <span>
                        <i class="material-icons md-calendar_today"></i> <b>{{order.created_at}}</b>
                    </span> <br>
                    <small class="text-muted">Order ID: {{order.order_number}}</small><br>  
                    <small class="text-muted">Status: <span class="text-danger">{{ order.status }}</span></small>
                </div>
            </div>
        </header>

        <div class="card-body">
            <!-- Section 1: Info Grid -->
            <div class="row mb-50 mt-20" style="border:1px solid #ccc; padding:15px; border-radius:5px; background:#f9f9f9;">
                <!-- Billing Address -->
                <div class="col-md-3">
                    <div class="card h-100">
                        <h5 class="card-header">Billing Address</h5>
                        <div class="card-body">
                            <p class="card-text">{{order.payment.payment_method}}</p>
                            <h5 class="card-title">{{order.user.username}}</h5>
                            <p class="card-text">{{order.billing_address.house}}</p>
                            <p class="card-text">{{order.billing_address.street}} ,{{order.billing_address.landmark}}</p>
                            <p class="card-text">{{order.billing_address.town}} ,{{order.billing_address.state}}</p>
                            <p class="card-text">{{order.billing_address.pincode}}</p>
                            {% if order.order_note %}
                            <b>Order note:</b>{{order.order_note}}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="col-md-3">
                    <div class="card h-100">
                        <h5 class="card-header">Shipping Address</h5>
                        <div class="card-body">
                            <h5 class="card-title">{{order.user.username}}</h5>
                            <p class="card-text">{{order.shipping_address.house}}</p>
                            <p class="card-text">{{order.shipping_address.street}} ,{{order.shipping_address.landmark}}</p>
                            <p class="card-text">{{order.shipping_address.town}} ,{{order.shipping_address.state}}</p>
                            <p class="card-text">{{order.shipping_address.pincode}}</p>
                        </div>
                    </div>
                </div>

                <!-- Order Info -->
                <div class="col-md-3">
                    <div class="card h-100">
                        <h5 class="card-header">Order Info</h5>
                        <div class="card-body">
                            <p class="mb-1">Pay method: {{order.payment.payment_method}}</p>
                            <p class="mb-1">Status: {{order.status}}</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="col-md-3">
                    <div class="card h-100">
                        <h5 class="card-header">Payment Info</h5>
                        <div class="card-body">
                            <p>{{order.payment.user}}</p>
                            <p>Payment ID: {{order.payment.payment_id}}</p>
                            <p>Method: {{order.payment.payment_method}}</p>
                            <p>Amount Paid: {{order.payment.amount_paid}}</p>
                            <p>Status: {{order.payment.status}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Product Table -->
            <div class="row" style="border:1px solid #ccc; padding:15px; border-radius:5px; background:#fff;">
                <div class="col-lg-12">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="25%">Product</th>
                                    <th width="12%">Unit Price</th>
                                    <th width="10%">Quantity</th>
                                    <th width="12%" class="text-end">Total</th>
                                    <th width="15%">Status</th>
                                    <th width="15%">Actions</th>
                                    <th width="11%">Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order_products %}
                                <tr>
                                    <td class="image product-thumbnail">
                                        <img src="{{ item.product.image.url }}" alt="#">                                                    
                                        <h5 class="product-name"><a href="{% url 'app:product_detail' item.product.pid %}">{{ item.product.title }}</a></h5>
                                        <p class="font-xs">
                                            {% if item.variations.all %}
                                                {% for iteme in item.variations.all %}
                                                    <li>Size:{{ iteme.size|upper }}</li>
                                                {% endfor %}
                                           {% endif %}
                                        </p>
                                    </td>
                                    <td class="price" data-title="Price"><span><span>₹</span>{{ item.product.price|floatformat:2 }}</span></td>
                                    <td>{{item.quantity}}</td>
                                    <td>{{item.total_price}}</td>
                                    
                                    <!-- Item Status -->
                                    <td>
                                        {% if item.item_status == 'Ordered' %}
                                            <span class="badge bg-success">{{ item.item_status }}</span>
                                        {% elif item.item_status == 'Cancelled' %}
                                            <span class="badge bg-danger">{{ item.item_status }}</span>
                                        {% elif item.item_status == 'Returned' %}
                                            <span class="badge bg-warning">{{ item.item_status }}</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Individual Item Actions -->
                                    <td>
                                        {% if item.item_status == 'Ordered' %}
                                            {% if order.status not in 'Delivered,Cancelled,Returned' %}
                                                <form method="post" action="{% url 'orders:cancel_order_item' item.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-sm" 
                                                            onclick="return confirm('Are you sure you want to cancel this item?')">
                                                        Cancel
                                                    </button>
                                                </form>
                                            {% endif %}
                                            
                                            {% if order.status == 'Delivered' %}
                                                <form method="post" action="{% url 'orders:return_order_item' item.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-warning btn-sm" 
                                                            onclick="return confirm('Are you sure you want to return this item?')">
                                                        Return
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% else %}
                                            <small class="text-muted">No actions available</small>
                                        {% endif %}
                                    </td>

                                    <!-- Rating Field -->
                                   <td>
                                        {% if order.status == 'Delivered' and item.item_status == 'Ordered' %}
                                        <form method="post" action="{% url 'orders:add_rating' item.id %}">
                                            {% csrf_token %}
                                            <select name="rating" required class="form-select form-select-sm">
                                                <option value="">⭐ Rate</option>
                                                {% for i in "12345" %}
                                                <option value="{{ i }}" {% if item.user_rating|stringformat:"s" == i %} selected {% endif %}>{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                            <textarea name="review" rows="2" class="form-control mt-1" placeholder="Write a review...">{{ item.user_review }}</textarea>
                                            <button type="submit" class="btn btn-primary btn-sm mt-2">Submit</button>
                                        </form>
                                        {% elif item.item_status != 'Ordered' %}
                                        <small class="text-muted">Not available</small>
                                        {% else %}
                                        <small class="text-muted">Rating available after delivery</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}

                                <tr>
                                    <td colspan="7">
                                        <article class="float-end">
                                            <dl class="dlist">
                                                <dt>Subtotal:  {{subtotal}}</dt>
                                            </dl>
                                            <dl class="dlist">
                                                <dt>Shipping cost:  +{{order.shipping}}</dt>
                                            </dl>
                                            <dl class="dlist">
                                                <dt>Coupon:
                                                    <em>- ₹{{ coupon_discount|default:"0.00"|floatformat:2 }} 
                                                    {% if order.coupon.discount %} ({{ order.coupon.discount }}%) {% endif %}</em>
                                                </dt>
                                            </dl>
                                            <dl class="dlist">
                                                <dt>Offer:-{{order.offer_price}}</dt>
                                            </dl>
                                            <dl class="dlist">
                                                <dt>Grand total:</dt>
                                                <dd> <b class="h5">{{order.order_total}}</b> </dd>
                                            </dl>
                                            <dl class="dlist">
                                                <dt class="text-muted">Status:</dt>
                                                <dd>
                                                    <span class="badge rounded-pill alert-success text-success">{{order.payment.status}}</span>
                                                </dd>
                                            </dl>
                                            {% if order.status == 'Cancelled' or order.status == 'Returned' %}
                                            <dl class="dlist">
                                                <dt class="text-muted">Refund Status:</dt>
                                                <dd>
                                                    {% if order.refund_status == 'none' %}
                                                        <span class="badge rounded-pill alert-secondary text-secondary">No Refund</span>
                                                    {% elif order.refund_status == 'partial' %}
                                                        <span class="badge rounded-pill alert-warning text-warning">Partial Refund (₹{{order.refund_amount}})</span>
                                                    {% elif order.refund_status == 'full' %}
                                                        <span class="badge rounded-pill alert-info text-info">Full Refund (₹{{order.refund_amount}})</span>
                                                    {% endif %}
                                                </dd>
                                            </dl>
                                            {% endif %}
                                        </article>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Cancel / Return / Payment Buttons -->
                    <div class="row mt-3">
                        <!-- Show order-level cancel only if there are items that can be cancelled -->
                        {% if order.status not in 'Cancelled,Returned,Delivered' and has_cancellable_items %}
                            <div class="col-6">
                                <form method="post" action="{% url 'userauth:cancel_order' order.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">Cancel Entire Order</button>
                                </form>
                            </div>
                        {% endif %}

                        {% if order.payment.status == 'Payment pending' %}
                        <div class="col-6">
                            <form method="post" action="{% url 'orders:payment_pending' order.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">Complete payment</button>
                            </form>
                        </div>
                        {% endif %}

                        <!-- Show order-level return only if there are items that can be returned -->
                        {% if order.status == 'Delivered' and order.payment.status != 'Payment pending' and has_returnable_items %}
                            <div class="col-6">
                                <form id="returnOrderForm" method="post" action="{% url 'userauth:return_order' order.id %}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-warning" onclick="confirmReturn()">Return Entire Order</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>

    <button onclick="printInvoice()" class="btn btn-primary mt-3">Print Invoice</button>
</section>

<script>
function confirmReturn() {
    if (confirm('Are you sure you want to return this order?')) {
        document.getElementById('returnOrderForm').submit();
    }
}

function printInvoice() {
    var buttonsToHide = document.querySelectorAll('button');
    buttonsToHide.forEach(function(button) { button.style.display = 'none'; });
    var elementsToHide = document.querySelectorAll('.container-1, .invoice-footer');
    elementsToHide.forEach(function(element) { element.style.display = 'none'; });
    var contentToPrint = document.querySelector('.content-main').innerHTML;
    var originalContent = document.body.innerHTML;
    document.body.innerHTML = contentToPrint;
    window.print();
    document.body.innerHTML = originalContent;
    elementsToHide.forEach(function(element) { element.style.display = 'block'; });
    buttonsToHide.forEach(function(button) { button.style.display = 'block'; });
}
</script>
{% endblock content %}
