{% extends "partials/base.html" %}
{% block content %}


<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Wishlist
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col" colspan="2">Product</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Stock Status</th>
                                    <th scope="col">Action</th>
                                    <th scope="col">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                                {% for product in wishlist_items %}          
                              <tr>
                                   
                                    <td class="image product-thumbnail"><img src="{{product.image.url}}" alt="#"></td>
                                    <td class="product-des product-name">
                                        <h5 class="product-name"><a href="{% url 'app:product_detail' product.pid %}">{{product.title}}</a></h5>
                                        <p class="font-xs">{{product.anime}},{{product.character}}<br> {{product.descriptions}}
                                        </p>
                                    </td>
                                    <td class="price" data-title="Price"><span>{{product.price}}</span></td>
                                    <td class="text-center" data-title="Stock">
                                        <span class="color3 font-weight-bold">{{product.in_stock}}</span>
                                    </td>
                                    <td class="text-right" data-title="Cart">
                                        <!-- <a href="{% url 'cart:add_cart' product.pid %}"  class="btn btn-sm"><i class="fi-rs-shopping-bag mr-5"></i>Add to cart</a> -->
                                           {% if product in out_of_stock_products %}
                                            <p style="color:red;">Out of stock</p>
                                        {% else %}
                                        <a href="javascript:void(0);" class="btn btn-sm add-to-cart-btn" data-product-id="{{ product.pid }}">
                                            <i class="fi-rs-shopping-bag mr-5"></i>Add to cart
                                        </a>
                                    {% endif %}
                                    </td>
                                    <td class="action" data-title="Remove">
                                        <a href="#" id="removeLink_{{ product.pid }}" data-product-id="{{ product.pid }}"><i class="fi-rs-trash"></i></a>
                                        {% comment %} <a href="{% url "app:remove_from_wishlist" product.pid %}"><i class="fi-rs-trash"></i></a> {% endcomment %}
                                    </td>                             </tr>
                                {% endfor %}
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div>
            {% if wishlist_items.has_previous %}
            <a href="?page=1">&laquo; First</a>
            <a href="?page={{ wishlist_items.previous_page_number }}">Previous</a>
            {% endif %}
            
            Page {{ wishlist_items.number }} of {{ wishlist_items.paginator.num_pages }}
            
            {% if wishlist_items.has_next %}
            <a href="?page={{ wishlist_items.next_page_number }}">Next</a>
            <a href="?page={{ wishlist_items.paginator.num_pages }}">Last &raquo;</a>
            {% endif %}
        </div>
    </section>


</main>


<!-- Size Modal -->
<div class="modal fade" id="sizeModal" tabindex="-1" aria-labelledby="sizeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Size</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="sizeForm">
          <input type="hidden" id="modal-product-id">
          <div class="size-options" id="size-options"></div>
          <button type="submit" class="btn btn-primary mt-3">Add to Cart</button>
        </form>
      </div>
    </div>
  </div>
</div>








 <script>
    document.addEventListener("DOMContentLoaded", function() {
        var removeLinks = document.querySelectorAll("[id^='removeLink_']");
        removeLinks.forEach(function(link) {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                var productId = this.getAttribute("data-product-id");
                if (confirm('Are you sure you want to remove this item from your wishlist?')) {
                    var url = "/remove-from-wishlist/" + productId + "/";
                    window.location.href = url;
                }
            });
        });
 






    // Wishlist add-to-cart
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            const pid = this.getAttribute('data-product-id');
            document.getElementById('modal-product-id').value = pid;

            // Fetch sizes via AJAX
            fetch(`/get_sizes/${pid}/`)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('size-options');
                    container.innerHTML = '';
                    data.sizes.forEach(size => {
                        const label = document.createElement('label');
                        label.classList.add('me-3');
                        label.style.display = 'inline-flex';
                        label.style.alignItems = 'center';
                        label.innerHTML = `<input type="radio" name="${pid}" value="${size.size}" style="margin-right: 5px;"> ${size.size}`;
                        container.appendChild(label);
                        container.appendChild(document.createElement('br'));
                    });

                    var myModal = new bootstrap.Modal(document.getElementById('sizeModal'));
                    myModal.show();
                });
        });
    });

    document.getElementById('sizeForm').addEventListener('submit', function(e){
        e.preventDefault();
        const pid = document.getElementById('modal-product-id').value;
        const selectedInput = document.querySelector(`input[name="${pid}"]:checked`);
        if(!selectedInput){
            alert("Please select a size.");
            return;
        }

        const formData = new FormData();
        formData.append(selectedInput.name, selectedInput.value);

        fetch(`/add_cart/${pid}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(async res => {
            const text = await res.text();
            try {
                const data = JSON.parse(text);
                if(data.success){
                    const sizeModalEl = document.getElementById('sizeModal');
                    const sizeModal = bootstrap.Modal.getInstance(sizeModalEl);
                    if(sizeModal) sizeModal.hide();
                    alert("Product added to cart!");
                } else if(data.status === 'error'){
                    alert(data.message);
                }
            } catch(err){
                window.location.href = "/cart/";
            }
        })
        .catch(err => {
            console.error(err);
            alert("Something went wrong. Please try again.");
        });
    });



   });








</script> 


{% endblock content %}

