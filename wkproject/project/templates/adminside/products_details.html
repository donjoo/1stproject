
{% extends "partials/admin_base.html" %}
{% load static %}
{% load custom_filters %}
{% block body %}
<section class="mt-50 mb-50">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12">
                <div class="detail-gallery">
                    <span class="zoom-icon"><i class="fi-rs-search"></i></span>

                    <!-- MAIN SLIDES -->
                    <div class="product-image-slider">
                        <figure class="border-radius-10">
                            <img src="{{product.image.url}}" alt="product image" loading="lazy">
                        </figure>
                        {% for p in p_image %}
                        {% if p.Images %}
                        <figure class="border-radius-10">
                            <img src="{{ p.Images.url }}" alt="product image" loading="lazy">
                        </figure>
                        {% endif %}
                        {% endfor %}
                    </div>

                    <!-- THUMBNAILS -->
                    <div class="slider-nav-thumbnails pl-15 pr-15">
                        <div><img src="{{ product.image.url }}" alt="product image"></div>
                        {% for p in p_image %}
                        {% if p.Images %}
                          <div><img src="{{ p.Images.url }}" alt="product image"></div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-sm-12 col-xs-12">
                <div class="detail-info">
                    <h2 class="title-detail">{{product.title}}</h2>
                    <div class="product-detail-rating">
                        <div class="pro-details-brand">
                            <span> Anime: <a href="shop-grid-right.html">{{product.anime}}</a></span>
                        </div>
                    </div>
                    <div class="rating">
                        {% for i in "12345"|make_list %}
                            {% if forloop.counter <= avg_rating %}
                                <i class="fi-rs-star text-warning"></i>
                            {% else %}
                                <i class="fi-rs-star text-muted"></i>
                            {% endif %}
                        {% endfor %}
                        <span>({{ avg_rating }} / 5)</span>
                    </div>

                    <div class="clearfix product-price-cover">
                        <div class="product-price primary-color float-left">
                            <ins> <span>₹</span><span class="current-price current-product-price-{{ product.id }} text-brand">{{product.price}}</span></ins>
                            <ins> <span class="old-price font-md ml-15"><span>₹</span>{{product.old_price}}</span></ins>
                        </div>
                    </div>
                    <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                    
                    <div class="product_sort_info font-xs mb-30">
                       
                    </div>
                   
                    <div class="attr-detail attr-size">
                        <div class="row">
                        
                                <h6>Sizes: </h6>
                                    {% for size, status in sizes_out_of_stock.items %}
                                    {% if status %}
                                        <p value="{{ size }}" disabled>{{ size }} (Out of stock)</p>
                                    {% else %}
                                        <p value="{{ size }}">{{ size }}</p>
                                    {% endif %}
                                {% endfor %}                                                                                       
                        </div>                                            
                    </div>
                    <div class="attr-detail attr-size">          
                        <div class="row">                                         
                                <h6>Offers: </h6>
                                    {% for offer in offers  %}
                                    <p>Offer:<span style="color: red;">₹{{ offer.discount }} off</span></p>
                          {% endfor %}
                          <h6>Category Offers: </h6>
                          {% for off in catoffers  %}
                          <p>Offer:<span style="color: red;">₹{{ off.discount }} off</span></p>
                          {% endfor %}  
                        </div>                                      
                    </div>                            
                    </div>
                    <div class="bt-1 border-color-1 mt-30 mb-30"></div>                                                                          
                </div>
           
                <!-- Detail Info -->
            </div>
        </div> 
                    </div>
                    
                    <!-- Stock & Variants Management Section -->
                    <div class="row">
                        <div class="col-lg-12 m-auto entry-main-content">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h2 class="section-title style-1 mb-0">Stock & Variants Management</h2>
                                    <a href="{% url 'adminside:add_newvariant_product' product.pid %}" class="btn btn-sm btn-primary">
                                        <i class="material-icons md-add"></i> Add New Variant
                                    </a>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="info-box">
                                                <h5>Total Stock</h5>
                                                <span class="badge {% if total_stock == 0 %}bg-danger{% elif total_stock < 10 %}bg-warning text-dark{% else %}bg-success{% endif %} fs-4">
                                                    {{ total_stock }} units
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="info-box">
                                                <h5>Total Variants</h5>
                                                <span class="badge bg-info fs-4">{{ variants_with_stock|length }} variant{{ variants_with_stock|length|pluralize }}</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="info-box">
                                                <h5>Low Stock Variants</h5>
                                                <span class="badge {% if low_stock_count == 0 %}bg-success{% else %}bg-warning text-dark{% endif %} fs-4">
                                                    {{ low_stock_count }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if variants_with_stock %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Size</th>
                                                    <th>Current Stock</th>
                                                    <th>Status</th>
                                                    <th>Update Stock</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for variant_data in variants_with_stock %}
                                                <tr id="variant-row-{{ variant_data.variant.id }}">
                                                    <td>
                                                        <strong>{{ variant_data.variant.size }}</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge {% if variant_data.stock == 0 %}bg-danger{% elif variant_data.stock < 5 %}bg-warning text-dark{% else %}bg-success{% endif %} fs-6" id="stock-badge-{{ variant_data.variant.id }}">
                                                            {{ variant_data.stock }} units
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge {% if variant_data.is_active %}bg-success{% else %}bg-secondary{% endif %}" id="status-badge-{{ variant_data.variant.id }}">
                                                            {% if variant_data.is_active %}Active{% else %}Inactive{% endif %}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="input-group" style="max-width: 200px;">
                                                            <input type="number" 
                                                                   class="form-control form-control-sm stock-input" 
                                                                   id="stock-input-{{ variant_data.variant.id }}"
                                                                   value="{{ variant_data.stock }}" 
                                                                   min="0" 
                                                                   data-variant-id="{{ variant_data.variant.id }}"
                                                                   data-stock-id="{{ variant_data.stock_id }}">
                                                            <button class="btn btn-sm btn-primary update-stock-btn" 
                                                                    data-variant-id="{{ variant_data.variant.id }}"
                                                                    data-stock-id="{{ variant_data.stock_id }}">
                                                                <i class="material-icons md-check"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" 
                                                                    class="btn btn-sm {% if variant_data.is_active %}btn-warning{% else %}btn-success{% endif %} toggle-variant-btn"
                                                                    data-variant-id="{{ variant_data.variant.id }}"
                                                                    data-is-active="{{ variant_data.is_active|lower }}">
                                                                    {% if variant_data.is_active %}<i class="material-icons md-block"></i> Block{% else %}<i class="material-icons md-check"></i> Activate{% endif %}
                                                            </button>
                                                            <a href="{% url 'adminside:delete_size' variant_data.variant.id %}?from_detail=1" 
                                                               class="btn btn-sm btn-danger" 
                                                               onclick="return confirm('Are you sure you want to delete this variant?');">
                                                                <i class="material-icons md-delete"></i> Delete
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        <p class="mb-0">No variants found for this product. <a href="{% url 'adminside:add_newvariant' %}">Add a variant</a> to manage stock.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-10 m-auto entry-main-content">
                            <h2 class="section-title style-1 mb-30">Description</h2>
                            <div class="description mb-50">
                                <p>{{product.descriptions}}</p>
                                
                                <ul class="product-more-infor mt-30">
                                    <li><span>style</span> {{product.fit}}</li>
                                    <li><span>Fabric</span> {{product.fabric}}</li>
                                </ul>
                                <hr class="wp-block-separator is-style-dots">
                                <p>{{product.specifications}}</p>
                             
                                </p>
                            </div>
                            <h3 class="section-title style-1 mb-30">Additional info</h3>
                            <table class="font-md mb-30">
                                <tbody>
                                    <tr class="stand-up">
                                        <th>Fit style</th>
                                        <td>
                                            <p>{{product.fit}}</p>
                                        </td>
                                    </tr>
                                    <tr class="folded-wo-wheels">
                                        <th>Fabric</th>
                                        <td>
                                            <p>{{product.fabric}}</p>
                                        </td>
                                    </tr>
                                    <tr class="folded-w-wheels">
                                        <th>Care</th>
                                        <td>
                                            <p>{{product.care}}</p>
                                        </td>
                                    </tr>
                                    <tr class="door-pass-through">
                                        <th>Sleeve type</th>
                                        <td>
                                            <p>{{product.sleeve}}</p>
                                        </td>
                                    </tr>
                                    <tr >
                                        <th>Collar style</th>
                                        <td>
                                            <p>{{product.collar}}</p>
                                        </td>
                                    </tr>
                                    
                                </tbody>
                            </table>
                            
                            <!-- RATINGS AND REVIEWS SECTION -->
                            <h2 class="section-title style-1 mb-30">Product Ratings & Reviews</h2>
                            
                            <!-- Rating Summary -->
                            <div class="rating-summary mb-40">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="overall-rating text-center">
                                            <div class="rating-number">{{ avg_rating|floatformat:1 }}</div>
                                            <div class="rating-stars">
                                                {% for i in "12345"|make_list %}
                                                    {% if forloop.counter <= avg_rating %}
                                                        <i class="fi-rs-star text-warning"></i>
                                                    {% else %}
                                                        <i class="fi-rs-star text-muted"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <div class="rating-count">{{ ratings.paginator.count }} review{{ ratings.paginator.count|pluralize }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="rating-breakdown">
                                            {% for i in "54321"|make_list %}
                                                {% with star_num=i|add:0 %}
                                                    {% with count=star_counts|lookup:star_num %}
                                                        {% with percentage=star_percentages|lookup:star_num %}
                                                            <div class="rating-bar">
                                                                <span class="rating-label">{{ i }} star{{ i|pluralize }}</span>
                                                                <div class="progress">
                                                                    <div class="progress-bar" style="width: {{ percentage }}%"></div>
                                                                </div>
                                                                <span class="rating-count">{{ count }}</span>
                                                            </div>
                                                        {% endwith %}
                                                    {% endwith %}
                                                {% endwith %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reviews List -->
                            <div class="reviews-section">
                                <h4>Customer Reviews</h4>
                                {% if ratings %}
                                    {% for rating in ratings %}
                                        <div class="review-item mb-30">
                                            <div class="review-header">
                                                <div class="reviewer-info">
                                                    <strong>{{ rating.user.username }}</strong>
                                                    <div class="rating-stars">
                                                        {% for i in "12345"|make_list %}
                                                            {% if forloop.counter <= rating.rating %}
                                                                <i class="fi-rs-star text-warning"></i>
                                                            {% else %}
                                                                <i class="fi-rs-star text-muted"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="review-date">
                                                    <small class="text-muted">{{ rating.created_at|date:"M d, Y" }}</small>
                                                </div>
                                            </div>
                                            {% if rating.review %}
                                                <div class="review-content">
                                                    <p>{{ rating.review }}</p>
                                                </div>
                                            {% endif %}
                                            <div class="review-actions mt-2">
                                                <form method="post" action="{% url 'adminside:delete_rating' rating.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this rating and review?')">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-sm">Delete Rating</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}

                                    <!-- Pagination -->
                                    {% if ratings.has_other_pages %}
                                        <nav aria-label="Reviews pagination">
                                            <ul class="pagination justify-content-center">
                                                {% if ratings.has_previous %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page=1">First</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ ratings.previous_page_number }}">Previous</a>
                                                    </li>
                                                {% endif %}
                                                
                                                <li class="page-item active">
                                                    <span class="page-link">
                                                        Page {{ ratings.number }} of {{ ratings.paginator.num_pages }}
                                                    </span>
                                                </li>
                                                
                                                {% if ratings.has_next %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ ratings.next_page_number }}">Next</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ ratings.paginator.num_pages }}">Last</a>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </nav>
                                    {% endif %}
                                {% else %}
                                    <p class="text-muted">No reviews yet for this product.</p>
                                {% endif %}
                            </div>
                            
                        </div>
                    </div>
                   
</main>
<script src="{% static 'assets/js/vendor/modernizr-3.6.0.min.js' %}" ></script>
    <script src="{% static 'assets/js/vendor/jquery-3.6.0.min.js' %}" ></script>
    <script src="{% static 'assets/js/vendor/jquery-migrate-3.3.0.min.js' %}" ></script>
    <script src="{% static 'assets/js/vendor/bootstrap.bundle.min.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/slick.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery.syotimer.min.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/wow.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery-ui.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/perfect-scrollbar.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/magnific-popup.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/select2.min.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/waypoints.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/counterup.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery.countdown.min.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/images-loaded.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/isotope.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/scrollup.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery.vticker-min.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery.theia.sticky.js' %}" ></script>
    <script src="{% static 'assets/js/plugins/jquery.elevatezoom.js' %}" ></script>
    <!-- Template  JS -->
    <script src="{% static 'assets/js/main.js' %}" ></script>
    <script src="{% static 'assets/js/shop.js' %}" ></script>

    <script>
    $(document).ready(function() {
        // Slick slider for main images
        if ($('.product-image-slider').length) {
            $('.product-image-slider').slick({
                slidesToShow: 1,
                slidesToScroll: 1,
                arrows: true,
                fade: true,
                asNavFor: '.slider-nav-thumbnails'
            });

            $('.slider-nav-thumbnails').slick({
                slidesToShow: 4,
                slidesToScroll: 1,
                asNavFor: '.product-image-slider',
                focusOnSelect: true,
                arrows: false
            });
        }
    });
    
    // Stock Management AJAX
    $(document).ready(function() {
        // Quick stock update
        $('.update-stock-btn').on('click', function(e) {
            e.preventDefault();
            const btn = $(this);
            const variantId = btn.data('variant-id');
            const stockId = btn.data('stock-id');
            const input = $('#stock-input-' + variantId);
            const newStock = parseInt(input.val());
            const badge = $('#stock-badge-' + variantId);
            
            if (isNaN(newStock) || newStock < 0) {
                alert('Please enter a valid stock quantity');
                return;
            }
            
            btn.prop('disabled', true).html('<i class="material-icons md-hourglass_empty"></i>');
            
            $.ajax({
                url: '{% url "adminside:update_stock_ajax" %}',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'stock_id': stockId,
                    'quantity': newStock
                },
                success: function(response) {
                    if (response.success) {
                        badge.text(newStock + ' units').removeClass('bg-danger bg-warning bg-success')
                            .addClass(newStock == 0 ? 'bg-danger' : (newStock < 5 ? 'bg-warning text-dark' : 'bg-success'));
                        input.val(newStock);
                        
                        // Update total stock display if exists
                        if ($('#total-stock-display').length) {
                            location.reload(); // Reload to update total
                        }
                    } else {
                        alert('Error: ' + (response.message || 'Failed to update stock'));
                    }
                },
                error: function() {
                    alert('Error updating stock. Please try again.');
                },
                complete: function() {
                    btn.prop('disabled', false).html('<i class="material-icons md-check"></i>');
                }
            });
        });
        
        // Allow Enter key to trigger update
        $('.stock-input').on('keypress', function(e) {
            if (e.which === 13) {
                $(this).siblings('.update-stock-btn').click();
            }
        });
        
        // Toggle variant active status
        $('.toggle-variant-btn').on('click', function(e) {
            e.preventDefault();
            const btn = $(this);
            const variantId = btn.data('variant-id');
            const isActive = btn.data('is-active') === 'true';
            const badge = $('#status-badge-' + variantId);
            
            btn.prop('disabled', true);
            
            // Build the URL - URL pattern is: block_size/<str:id>/
            // Since adminside URLs are included at root level in main urls.py, construct URL directly
            const blockSizeUrl = '/block_size/' + variantId + '/';
            
            $.ajax({
                url: blockSizeUrl,
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        const newIsActive = response.is_active;
                        badge.text(newIsActive ? 'Active' : 'Inactive')
                            .removeClass('bg-success bg-secondary')
                            .addClass(newIsActive ? 'bg-success' : 'bg-secondary');
                        
                        btn.removeClass('btn-warning btn-success')
                            .addClass(newIsActive ? 'btn-warning' : 'btn-success')
                            .html(newIsActive ? 
                                '<i class="material-icons md-block"></i> Block' : 
                                '<i class="material-icons md-check"></i> Activate');
                        btn.data('is-active', newIsActive);
                    } else {
                        alert('Error: ' + (response.message || 'Failed to update variant status'));
                    }
                },
                error: function() {
                    alert('Error updating variant status. Please try again.');
                },
                complete: function() {
                    btn.prop('disabled', false);
                }
            });
        });
    });
    </script>

    <style>
.product-image-slider figure {
    width: 100%;
    height: 400px; /* fixed height for the main image container */
    position: relative;
    background-color: #fff; /* white space */
    border-radius: 10px;
    overflow: hidden;
}

.product-image-slider figure img {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.slider-nav-thumbnails img {
    height: 80px;
    width: auto;
    cursor: pointer;
}

.rating i {
    font-size: 18px;
    margin-right: 2px;
}
.rating span {
    font-size: 14px;
    color: #555;
}
.text-warning {
    color: #ffc107;
}
.text-muted {
    color: #e0e0e0;
}

/* Ratings and Reviews Styles */
.rating-summary {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.overall-rating {
    padding: 20px;
}

.rating-number {
    font-size: 48px;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 10px;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 3px;
    margin-bottom: 10px;
}

.rating-stars i {
    font-size: 18px;
}

.rating-breakdown {
    padding: 20px 0;
}

.rating-bar {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}

.rating-label {
    width: 80px;
    font-size: 14px;
}

.progress {
    flex: 1;
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
}

.progress-bar {
    background-color: #007bff;
    border-radius: 4px;
}

.reviews-section {
    margin-top: 30px;
}

.review-item {
    border: 1px solid #e9ecef;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.reviewer-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.review-content {
    margin-top: 10px;
}

.review-content p {
    margin: 0;
    line-height: 1.6;
}

.pagination {
    margin-top: 30px;
}

.page-link {
    color: #007bff;
    border-color: #007bff;
}

.page-link:hover {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}

.page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}
    </style>
{% endblock body %}